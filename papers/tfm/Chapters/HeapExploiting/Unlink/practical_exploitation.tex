\subsection{Explotación práctica}

En este apartado se tratará la metodología para conseguir escribir 4 bytes en cualquier dirección de memoria, lo que, eventualmente, desembocará en la ejecución de código arbitrario tal y como se muestra en el Apéndice \ref{ap:II}, mediante la sobrescritura de la sección .dtors. \bigskip

El Código \ref{code:vulnerable_code} muestra el código vulnerable mediante el cual es posible controlar el contenido de los campos |bk| y |fd| de un fragmento de memoria libre, tal y como se planteaba en la página \pageref{ref:first_question}. \bigskip

\lstset{language=C, caption=Código vulnerable , label=code:vulnerable_code}
\begin{lstlisting}
#include <stdlib.h>
#include <string.h>

int main (int argc, char ** argv) {

        if (argc < 2)
                return -1;

        char * ptr_1 = (char *) malloc (512);
        char * ptr_2 = (char *) malloc (512);

        memcpy(ptr_1, argv[1], strlen(argv[1]));

        free(ptr_1);
        free(ptr_2);

        return 0;
}
\end{lstlisting}

Con las líneas 5 y 6 se crean dos búfers de datos de un tamaño de 512 bytes. Estos búfers se almacenarán en el \textit{heap} debido a que se piden al sistema mediante la función |malloc()|.\\
A continuación, en la línea 8 los datos que se pasan como argumento al programa se copian en el búfer |ptr_1|. La vulnerabilidad viene dada por el hecho de que si el tamaño del argumento pasado al programa es mayor a 512 bytes, se producirá un \textit{overflow} o desbordamiento del búfer, con lo que posiblemente se sobrescribirán otros búfers almacenados en el \textit{heap} o datos de control utilizados por el algoritmo de gestión de memoria dinámica. \\
Así pues, el requisito para poder sobrescribir el valor de los campos |bk| y |fd| pasa por que el desarrollador cometa un error que desemboque en un desbordamiento de búfer. \bigskip

Una vez se haya desbordado el búfer y se hayan sobrescrito ciertos datos, se ejecutará la macro \textit{unlink} mediante la liberación de dichos búfers - líneas 10 y 11 - y se conseguirá la ejecución de código arbitrario.

\input{./Chapters/HeapExploiting/Unlink/payload/construccion_payload.tex}

\pagebreak

\input{./Chapters/HeapExploiting/Unlink/pof/construccion_pof.tex}

\pagebreak

\input{./Chapters/HeapExploiting/Unlink/payload/construccion_payload_sin_null_bytes.tex}

\pagebreak

\input{./Chapters/HeapExploiting/Unlink/pof/construccion_pof_sin_null_bytes.tex}