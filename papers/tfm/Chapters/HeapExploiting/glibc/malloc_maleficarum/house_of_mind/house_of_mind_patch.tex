\subsubsection{Patch a la técnica The House of Mind}

Por desgracia, no todo lo bueno dura. En la versión 2.11 de la \textit{glibc} se corrigió esta vulnerabilidad. Aun cuando la técnica de The House of Mind era tan compleja, los desarrolladores de la \textit{glibc} encontraron una solución elegante al problema. El Código \ref{code:house_of_mind_patch} la muestra. \bigskip

\lstset{language=C, caption=Patch a The House of Mind, label=code:house_of_mind_patch}
\begin{lstlisting}
bck = unsorted_chunks(av);
fwd = bck->fd;
if (__builtin_expect (fwd->bk != bck, 0))
   {
      errstr = "malloc(): corrupted unsorted chunks";
      goto errout;
   }
\end{lstlisting}

Como se puede ver, la condición comprueba la integridad de la lista doblemente enlazada de \textit{unsorted chunks} de un modo parecido a como ocurría con la solución para la vulnerabilidad \textit{unlink}. Evidentemente, al llevar a cabo The House of Mind la lista de \textit{unsorted chunks} no está como debería con lo que la condición es verdadera y, por tanto, no se ejecuta la sobrescritura. \bigskip

Sin embargo, se debería realizar un estudio a fondo para contrastar si esta medida de seguridad realmente evita la ejecución de la técnica The House of Mind. Partiendo de la base que la dirección del puntero |bck| y el contenido a donde apunta lo puede controlar el atacante, se hace evidente que se puede controlar la dirección de |bck->fd|, o sea, |fwd|. Sabiendo que |bck| apunta al primer fragmento de memoria, |bck->fd|, apunta a la dirección contenida en primer fragmento de memoria más 8 bytes. Para no cumplir la condición, la dirección contenida donde apunta |fwd| más 12 bytes debería ser igual a |bck|, o sea, igual a la dirección del primer fragmento de memoria. \bigskip

Un esquema gráfico para evadir esta medida de seguridad se retrata en la Figura \ref{fig:bypass_patch}. En |bck->fd| se ha elegido poner la dirección del segundo fragmento de memoria simplemente porque es una región de memoria de la que se pueden controlar sus contenidos. Se podría haber elegido cualquier otra dirección de la que se pudiera controlar los datos que contiene.\bigskip

\begin{figure}[!htbp]  
    \centering
    \includegraphics[scale=.85]{./Chapters/HeapExploiting/glibc/malloc_maleficarum/house_of_mind/img/bypass_patch.eps}   
    \caption{Evasión del patch}
    \label{fig:bypass_patch}
\end{figure}

El problema viene con que el primer fragmento de memoria simula una estructura \textit{arena}. Si en dicha estructura, ahí donde se debe escribir la dirección hacia la región de memoria que el atacante controla, o sea si en |bck->fd| hay datos relevantes para llevar a cabo la técnica de The House of Mind, esta evasión no se podría levar a cabo. \bigskip

Sin embargo, cogiendo la estructura \textit{arena} en la versión de la \textit{glibc} 2.3.5 o la 2.12.1, si la constante |THREAD_STATS| estuviera definida, en la dirección |bck->fd| se sobrescribiría el valor de una de las variables para llevar a cabo cálculos estadísticos |stat_lock_loop| o |stat_lock_direct|, respectivamente. Por lo tanto no tendría que haber ningún problema para evadir esta medida de seguridad. \\
Si la constante |THREAD_STATS| no estuviera definida, se sobrescribiría el array de \textit{fastbins} que, teniendo en cuenta que con esta técnica no se utiliza para nada, no ocasionaría ningún problema y, por tanto, también tendría que permitir la evasión de la medida de seguridad. 