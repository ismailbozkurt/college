\subsection{Malloc Maleficarum}

El texto Malloc Maleficarum\cite{MM} se escribió con el propósito de evadir las nuevas medidas de seguridad que se habían implantado en la glibc para evitar la explotación del algoritmo a través de las vulnerabilidades explicadas en los apartados anteriores y otras vulnerabilidades que no se han detallado. \bigskip

La grandeza de este texto reside en que a finales del 2004 la glibc fue mejorada de tal manera que el código parecía inexpugnable. Los desarrolladores habían corregido cada una de las vulnerabilidades del algoritmo, de modo que todos los \textit{exploits} que se basaban en la explotación del \textit{heap} se volvieron obsoletos. Parecía que la gestión de memoria dinámica en sistemas Linux volvía a ser segura. Sin embargo, la felicidad de los desarrolladores duró apenas un año, pues a finales de 2005 Phantasmal Phantasmagoria publicaba un texto en el que teorizaba sobre no uno, sino cinco métodos para explotar el \textit{heap}. \bigskip

Aun así, en el Malloc Maleficarum sólo se asentaban las bases teóricas para vulnerar el algoritmo, de modo que en dicho texto no existían pruebas de concepto que demostraran lo que en ellos se afirmaba. Aun así, fue el primer atisbo que demostraba que lo que durante un tiempo pareció imposible, se tornaba posible. Fue entonces cuando muchos hackers alrededor del mundo empezaron a darle vueltas al texto de Phantasmal, de este modo en 2007 K-sPecial publicó The House of Mind\cite{THOM} en el \textit{ezine .aware}. En dicho texto, K-sPecial demostraba como uno de los métodos detallados por Phantasmal era factible y, de paso, corregía alguno de los errores existentes en el Malloc Maleficarum. Esta vez la prueba de concepto sí que fue liberada al público. \bigskip

Siguiendo la misma línea, en el 2009 \textit{blackngel} publicó el texto Malloc Des-Maleficarum \cite{MDM} en el \textit{ezine Phrack}. En este texto no sólo se repasaba una de las técnicas de Phantasmal, sino que se detallaban todas y cada una de modo que en la medida de lo posible se publicaba la prueba de concepto que demostraba que dicha técnica era viable o, por el contrario, era demasiado esotérica. \bigskip

En el Malloc Des-Maleficarum, al igual que en el Malloc Maleficarum, el conjunto de técnicas estaban identificadas como diferentes casas. \textit{The House of Mind, The House of Prime, The House of Spirit, The House of Force y The House of Lore}. La Tabla \ref{tab:house_effectivity} muestra la efectividad de cada una tal y como \textit{blackngel} retrató en el texto citado. \bigskip

\UndefineShortVerb{\|} %% Necesario para poner la barra vertical entre las filas de la tabla (linea 153).
\begin{table}[!htp]
	\topfigrule
   	\addtolength{\abovecaptionskip}{-12pt}   	   		
	\begin{center}
	\begin{tabular}{| l | c |}
		\hline
		Técnica & Efectividad \\
		\hline
		The House of Mind & glibc 2.8 \\
		\hline
		The House of Prime & glibc 2.3.6 \\
		\hline
		The House of Spirit & Todas las versiones de glibc hasta 2009 \\
		\hline
		The House of Force & glibc 2.8 \\
		\hline
		The House of Lore & Explotación no probada \\
		\hline
	\end{tabular}
	\end{center}
	\caption{Efectividad de las técnicas del Malloc Maleficarum}
	\label{tab:house_effectivity}
\end{table}
\DefineShortVerb{\|} 

En el 2009, momento en el que \textit{blackangel} publicó su documento, la versión vigente de la \textit{glibc} era la 2.8, de modo que tal y como se puede ver, la mayoría de las técnicas detalladas por Phantasmal todavía funcionaban aun habiendo transcurrido 4 años desde la publicación de su artículo.\bigskip

Si bien es cierto que la explotación de alguna de las técnicas presentadas por Phantasmal requería un conjunto de precondiciones que hacía que la explotación del algoritmo en una situación real fuera poco probable. Por ejemplo, tanto en \textit{The House of Spirit} y \textit{The House of Force} era necesario poder controlar algunos datos almacenados en el \textit{stack}, de modo que el atacante tenía que ser capaz de escribir datos en variables almacenadas en el \textit{stack} lo que significa que ya no sólo bastaba con un desbordamiento de búfer en el \textit{heap}. \bigskip

Otro dato interesante es que desde el 2009 hasta la fecha actual - finales del 2012 - no ha habido ninguna otra noticia sobre la explotación del \textit{heap}. Desde la versión 2.8 de la \textit{glibc} hasta la versión actual, la 2.16 no se conoce cual es el estado de cada una de estas técnicas. \\
Es por esta razón que en el próximo apartado se detallará cual es el estado de una de las técnicas más factibles de llevar a cabo en un escenario real\footnote{Exploit aprovechando un error en la gestión de un puntero en el heap y utilizando la técnica \textit{house of mind} para explotarlo: \\ \url{https://sites.google.com/site/felipeandresmanzano/popplerPOC.tar.bz2}}. 

\pagebreak

\input{./Chapters/HeapExploiting/glibc/malloc_maleficarum/house_of_mind/house_of_mind.tex}

\input{./Chapters/HeapExploiting/glibc/malloc_maleficarum/house_of_mind/house_of_mind_patch.tex}