\subsection{Arena}

La siguiente estructura a analizar es |malloc_state|. Esta estructura es la que se conoce como \textit{arena}. El código que la define es el siguiente: \bigskip

\lstset{language=C, caption=malloc\_state (malloc.c:2362), label=code:malloc_state_struct}
\begin{lstlisting}
struct malloc_state {
  /* Serialize access.  */
  mutex_t mutex;

  /* Flags (formerly in max_fast).  */
  int flags;

#if THREAD_STATS
  /* Statistics for locking.  Only used if THREAD_STATS is defined.  */
  long stat_lock_direct, stat_lock_loop, stat_lock_wait;
#endif

  /* Fastbins */
  mfastbinptr      fastbinsY[NFASTBINS];

  /* Base of the topmost chunk -- not otherwise kept in a bin */
  mchunkptr        top;

  /* The remainder from the most recent split of a small request */
  mchunkptr        last_remainder;

  /* Normal bins packed as described above */
  mchunkptr        bins[NBINS * 2 - 2];

  /* Bitmap of bins */
  unsigned int     binmap[BINMAPSIZE];

  /* Linked list */
  struct malloc_state *next;

#ifdef PER_THREAD
  /* Linked list for free arenas.  */
  struct malloc_state *next_free;
#endif

  /* Memory allocated from the system in this arena.  */
  INTERNAL_SIZE_T system_mem;
  INTERNAL_SIZE_T max_system_mem;
};
\end{lstlisting}

\begin{itemize}
\item \textbf{fastbinsY[...]}
\begin{myindentpar}{1cm}
En la variable |fastbin|\footnote{A partir de ahora a la variable \textit{fastbinY} se la llamará \textit{fastbin} ya que así es como se conoce al concepto que define.} se almacenan fragmentos de memoria que se han liberado recientemente. Esta variable almacena dichos fragmentos de memoria y se utilizan en un orden |LIFO| por cuestiones de rendimiento a diferencia de los \textit{bins}\footnote{El concepto \textit{bin} se definirá a continuación, por ahora basta con saber que con \textit{bin} se identifica a un espacio de memoria en el que almacenar y organizar los fragmentos de memoria asignados.} normales que se utilizan en un orden |FIFO| [malloc.c:2263].\\
Los fragmentos de memoria referenciados en la variable \textit{fastbin} mantienen su bit \textit{inuse}  [\ref{sec:memory_chunks}] a 1 de modo que estos fragmentos de memoria nunca se fusionan para crear un fragmento de memoria liberado más grande, a menos que se ejecute la función |malloc_consolidate|[malloc.c:5088] que libera los fragmentos de memoria de los \textit{fastbins} y los fusiona con otros fragmentos de memoria libres [malloc.c:2271].\\
El tipo de la variable \textit{fastbin} es un puntero a |malloc_chunk| tal y como se define en [malloc.c:2277]:\bigskip

\lstset{language=C, caption=mfastbinptr (malloc.c:2277), label=code:mfastbinptr}
\begin{lstlisting}
typedef struct malloc_chunk* mfastbinptr;
\end{lstlisting}
La estructura |malloc_chunk| se estudiará más adelante, sin embargo, se puede avanzar que dicha estructura identifica a un fragmento de memoria.\\
El número de \textit{fastbins} viene definido por la constante |NFASTBINS|, que en el caso de una arquitectura de 32 bits  donde el tamaño del tipo |size_t| es de 4 bytes el valor de la constante es 10\cite{UTHBBI}.\bigskip

El objetivo de esta variable es el de tener acceso a pequeños fragmentos de memoria que estén libres y a punto para poder almacenar datos de un modo eficiente. Esta estructura permite tener acceso a fragmentos de memoria libres de un modo eficiente, sin embargo, debido a que dichos fragmentos de memoria no se fusionan con otros fragmentos libres se incrementa el nivel de fragmentación de la memoria.\bigskip 
\end{myindentpar}

\item \textbf{top}
\begin{myindentpar}{1cm}
La variable \textit{top} es de tipo |mchunkptr| que como se puede ver a continuación no es más que un puntero a una estructura |malloc_chunk|:\bigskip
\lstset{language=C, caption=mchunkptr (malloc.c:1608), label=code:mchunkptr}
\begin{lstlisting}
struct malloc_chunk;
typedef struct malloc_chunk* mchunkptr;
\end{lstlisting}
La estructura |malloc_chunk| se estudiará más adelante, sin embargo, se puede avanzar que dicha estructura identifica a un fragmento de memoria.\\
Así pues, la variable \textit{top} identifica un fragmento de memoria en especial que delimita el final de la memoria disponible del \textit{arena}. Este fragmento no está almacenado en ningún \textit{bin} y representa el espacio libre o sin asignar del propio \textit{arena}. Sólo se asigna espacio de memoria del \textit{top} cuando no hay ningún otro fragmento de memoria libre [malloc.c:2217].
\end{myindentpar}

\item \textbf{last\_remainder}
\begin{myindentpar}{1cm}
Igual que la variable |top|, la variable |last_remainder| identifica un fragmento de memoria - |mchunkptr| - libre. Este fragmento de memoria es especial porque es el espacio restante cuando otro fragmento de memoria de poco tamaño se ha dividido para almacenar otros datos. Específicamente, |last_remainder| apunta al último fragmento de poco tamaño dividido [malloc.c:2380].\\
El uso de la variable |last_remainder| se da en [malloc.c:4401].
\end{myindentpar}

\item\label{lab:bin_definition} \textbf{bins[...]}
\begin{myindentpar}{1cm}
\paragraph{}\label{par:bins}
La variable |bins| es un array que apunta a diferentes fragmentos de memoria |mchunkptr|. El objetivo de la variable |bins| es mantener una lista de varios fragmentos de memoria libres y de diferentes tamaños. En la mayoría de los casos, cuando se haga una petición de memoria por parte del usuario, los datos se almacenarán en algún \textit{bin} que esté disponible y que sea del tamaño adecuado. Es por esta razón que esta estructura es una de las más importantes. Existen un total de 128 \textit{bins} definidos por la constante |NBINS| [malloc.c:2162], sin embargo, el tamaño del array |bins| es de |NBINS| * 2 - 2, o sea, 254.\\
La variable \textit{bins} es un array, pero cada uno de estos \textit{bins} - o posiciones del array - identifica un fragmento de memoria que está doblemente enlazado con otros fragmentos de memoria. Así pues, cada uno de los \textit{bins} apunta hacia una lista enlazada de fragmentos de memoria libres. De este modo, los fragmentos de memoria libres de los que dispone el proceso se organizan de un modo en el que su acceso es óptimo. \\
Tal y como se especifica en el código fuente [malloc.c:2141] existen los siguientes \textit{bins} con sus respectivos tamaños: \bigskip

\UndefineShortVerb{\|} %% Necesario para poner la barra vertical entre las filas de la tabla (linea 153).
\begin{table}[!htp]
	\topfigrule
   	\addtolength{\abovecaptionskip}{-12pt}   	
   	\caption{Tamaño de los bins}
   	\label{tab:bin_sizes}   		
	\begin{center}
	\begin{tabular}{c | c}
		\hline
		Número de bins & Tamaño del bin (bytes) \\
		\hline
		64 & 8 \\
		\hline
		32 & 64 \\
		\hline
		16 & 512 \\
		\hline
		8 & 4096 \\
		\hline
		4 & 32768 \\
		\hline
		2 & 262144 \\
		\hline
		1 & Lo que queda \\
		\hline
	\end{tabular}
	\end{center}
\end{table}
\DefineShortVerb{\|} 
\end{myindentpar}

\item \textbf{next}
\begin{myindentpar}{1cm}
Para puntualizar más que lo comentado en el código de la estructura |malloc_state| esta variable mantiene una lista enlazada circular de los \textit{arenas} existentes [arena.c:510]. Se puede ver su inicialización en [arena.c:944] cuando es necesario crear un nuevo \textit{arena}. De este modo se puede acceder a un \textit{arena} o a otro dependiendo de si dichos \textit{arenas} están siendo utilizados - y, por lo tanto, bloqueados - en el mismo momento en que se necesita hacer una reserva de memoria. \\
Evidentemente, debido a que enlaza otros \textit{arenas}, su tipo es un puntero a la estructura |malloc_state|.
\end{myindentpar}

\item \textbf{next\_free}
\begin{myindentpar}{1cm}
Esta variable es una lista de \textit{arenas} que supuestamente están libres. Sin embargo, en el código malloc.c no se le da ningún uso, o sea, que a efectos prácticos es como si no existiera. En el archivo de código arena.c existe una función llamada |get_free_list()| en la que se trabaja con dicha variable, sin embargo, esta función tampoco se ejecuta en ninguna parte de malloc.c.
\end{myindentpar}

\end{itemize}

Las variables que no se han detallado, no son relevantes para comprender a grandes rasgos cómo funciona la gestión de la memoria dinámica. Las variables |mutex|, |stat_lock_direct|, |stat_lock_loop| y |stat_lock_wait| tienen que ver con cuestiones de memoria compartida. La primera se encarga de bloquear el \textit{arena} cuando está en uso y las demás sirven para generar estadísticas sobre dichos bloqueos.\\
Por otro lado, el array |binmap[...]| sirve para saber si los \textit{bins} están vacíos o no. Utilizado por cuestiones de rendimiento cuando se ha de encontrar un \textit{bin} disponible.\\
Por último, las variables |system_mem| y |max_system_mem| sirven para saber cuanta memoria del sistema se ha almacenado en el propio \textit{arena}. \bigskip
